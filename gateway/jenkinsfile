node() {

  stage('checkout') {
    checkout scm
  }

  stage('docker-login') {
    withCredentials( [usernamePassword(credentialsId: 'docker-hub',  usernameVariable: 'username', passwordVariable: 'password')]) {
      sh 'docker login -u $username -p $password '
    }
  
  }
  stage('docker-pull') {
    sh 'docker pull sijibomi242/eventer-gateway-dev:latest'
  }
  parallel(
            'Quality Tests': {
                sh "docker run --rm sijibomi242/eventer-gateway-dev npm run lint"
            },
            'Integration Tests': {
                sh "docker run --rm sijibomi242/eventer-gateway-dev npm run test:ci"
            }
            // 'Coverage Reports': {
            //     sh "docker run --rm -v $PWD/coverage:/app/coverage sijibomi242/eventer-gateway-dev npm run coverage-html"
            //     publishHTML (target: [
            //         allowMissing: false,
            //         alwaysLinkToLastBuild: false,
            //         keepAll: true,
            //         reportDir: "$PWD/coverage",
            //         reportFiles: "index.html",
            //         reportName: "Coverage Report"
            //     ])
            // }
        )
  stage('pre-pod image') {
    sh "docker build -t sijibomi242/eventer-gateway-pre-prod:latest -t sijibomi242/eventer-gateway-pre-prod:${env.BUILD_NUMBER} -f ./gateway/Dockerfile.prod . "
    sh 'docker push sijibomi242/eventer-gateway-pre-prod --all-tags'
  }

  stage ('git push pre-prod'){
        sh 'git add -A'
        sh "git commit -m '${env.JOB_NAME} ${env.BUILD_NUMBER}'"
        sh "git remote add origin https://github.com/Sijibomii/eventer.git"
        sh "git push -u origin pre-prod"
        // sh 'dnf install gh'
        // sh "gh pr create -a @sijibomii -B pre-prod -H dev -b ${env.JOB_NAME} ${env.BUILD_NUMBER} -r sijibomii -t new commit"
  
  }
  // post {
  //     // success {
  //     // slackSend "Build deployed successfully - ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Open>)"
  //     // }
  //     success {
  //       scmInfo = checkout scm
  //       sh 'yum localinstall gh_*_linux_amd64.rpm'
  //       sh 'git checkout pre-prod'
  //       sh "gh pr create -a @sijibomii -B pre-prod -H dev -b ${env.JOB_NAME} ${env.BUILD_NUMBER} -r sijibomii -t ${scmInfo.GIT_COMMIT}"
  //     } 
  //  }
  // // post {
  // //   failure {
  // //       slackSend failOnError:true message:"Build failed  - ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Open>)"
  // //   }
  // // }

  
}